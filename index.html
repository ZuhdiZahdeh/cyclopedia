<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>الموسوعة التفاعلية للأطفال</title>

  <link rel="stylesheet" href="/css/colors.css" />
  <link rel="stylesheet" href="/css/fonts.css" />
  <link rel="stylesheet" href="/css/shared-utilities.css" />
  <link rel="stylesheet" href="/css/home.css" />
  <link rel="stylesheet" href="/css/forms.css" />
  <link rel="stylesheet" href="/css/common-components-subjects.css" />
  <link rel="stylesheet" href="/css/animals.css" />
  <link rel="stylesheet" href="/css/fruits.css" />
  <link rel="stylesheet" href="/css/vegetables.css" />
  <link rel="stylesheet" href="/css/human-body.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/alphabet-press.css" />
  <link rel="stylesheet" href="/css/memory-game.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
  <div id="app">
    <header class="top-navbar shadow">
      <nav class="top-nav-links">
        <a href="#" onclick="showHomePage()">🏠 الرئيسية</a>
        <a href="#" onclick="loadAnimalsPage()">📚 الحيوانات</a>
        <a href="#" onclick="loadFruitsPage()">🍎 الفواكه</a>
        <a href="#" onclick="loadVegetablesPage()">🥦 الخضروات</a>
        <a href="#" onclick="loadHumanBodyPage()">🧠 جسم الإنسان</a>
        <a href="#" onclick="loadAlphabetPressPage()">🎮 لعبة الحروف</a> <a href="#" onclick="loadMemoryGamePage()">🃏 الذاكرة</a>
      </nav>
    </header>

    <div class="page-layout">
      <aside class="sidebar shadow">
        <div id="animal-sidebar-controls" class="sidebar-section" style="display: none;">
          <h3 style="text-align: center;">🐾 تعرف على الحيوانات</h3>
          <div class="sidebar-game-controls">
            <div class="control-group">
              <label for="game-lang-select-animal">اللغة:</label>
              <select id="game-lang-select-animal">
                <option value="ar">العربية</option>
                <option value="en">English</option>
                <option value="he">عبري</option>
              </select>
            </div>
            <div class="control-group">
              <label for="voice-select-animal">الصوت:</label>
              <select id="voice-select-animal">
                <option value="teacher">المعلم</option>
                <option value="boy">صوت ولد</option>
                <option value="girl">صوت بنت</option>
                <option value="child">صوت طفل</option>
              </select>
            </div>
            <button id="play-sound-btn-animal" class="control-button">🔊 استمع</button>
            <div class="sidebar-navigation-buttons">
                <button id="prev-animal-btn" class="control-button">⬅️ السابق</button>
                <button id="next-animal-btn" class="control-button">التالي ➡️</button>
            </div>
          </div>
        </div>

        <div id="fruit-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">🍎 تعرف على الفواكه</h3>
            <div class="sidebar-game-controls">
                <div class="control-group">
                    <label for="game-lang-select-fruit">اللغة:</label>
                    <select id="game-lang-select-fruit">
                        <option value="ar">العربية</option>
                        <option value="en">English</option>
                        <option value="he">عبري</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="voice-select-fruit">الصوت:</label>
                    <select id="voice-select-fruit">
                        <option value="teacher">المعلم</option>
                        <option value="boy">صوت ولد</option>
                        <option value="girl">صوت بنت</option>
                        <option value="child">صوت طفل</option>
                    </select>
                </div>
                <button id="play-sound-btn-fruit" class="control-button">🔊 استمع</button>
                <div class="sidebar-navigation-buttons">
                    <button id="prev-fruit-btn" class="control-button">⬅️ السابق</button>
                    <button id="next-fruit-btn" class="control-button">التالي ➡️</button>
                </div>
            </div>
        </div>

        <div id="vegetable-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">🥦 تعرف على الخضروات</h3>
            <div class="sidebar-game-controls">
                <div class="control-group">
                    <label for="game-lang-select-vegetable">اللغة:</label>
                    <select id="game-lang-select-vegetable">
                        <option value="ar">العربية</option>
                        <option value="en">English</option>
                        <option value="he">عبري</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="voice-select-vegetable">الصوت:</label>
                    <select id="voice-select-vegetable">
                        <option value="teacher">المعلم</option>
                        <option value="boy">صوت ولد</option>
                        <option value="girl">صوت بنت</option>
                        <option value="child">صوت طفل</option>
                    </select>
                </div>
                <button id="play-sound-btn-vegetable" class="control-button">🔊 استمع</button>
                <div class="sidebar-navigation-buttons">
                    <button id="prev-vegetable-btn" class="control-button">⬅️ السابق</button>
                    <button id="next-vegetable-btn" class="control-button">التالي ➡️</button>
                </div>
            </div>
        </div>

        <div id="human-body-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">🧠 تعرف على جسم الإنسان</h3>
            <div class="sidebar-game-controls">
                <div class="control-group">
                    <label for="game-lang-select-human-body">اللغة:</label>
                    <select id="game-lang-select-human-body">
                        <option value="boy">صوت ولد</option>
                        <option value="teacher">المعلم</option>
                        <option value="girl">صوت بنت</option>
                        <option value="child">صوت طفل</option>
                    </select>
                </div>
                <button id="play-sound-btn-human-body" class="control-button">🔊 استمع</button>
                <div class="sidebar-navigation-buttons">
                    <button id="prev-human-body-btn" class="control-button">⬅️ السابق</button>
                    <button id="next-human-body-btn" class="control-button">التالي ➡️</button>
                </div>
            </div>
        </div>

        <div id="alphabet-press-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">🎮 إعدادات لعبة الحروف</h3>
            <div class="sidebar-game-controls">
                <div class="control-group">
                    <label for="alphabet-press-language-select">اختر اللغة:</label>
                    <select id="alphabet-press-language-select"></select>
                </div>

                <div class="control-group">
                    <label for="alphabet-press-category-select">اختر الفئة:</label>
                    <select id="alphabet-press-category-select"></select>
                </div>

                <div class="control-group">
                    <label for="alphabet-press-voice-select">اختر الصوت:</label>
                    <select id="alphabet-press-voice-select">
                        <option value="teacher" data-i18n="teacher_voice">المعلم</option>
                        <option value="boy" data-i18n="boy_voice">صوت ولد</option>
                        <option value="girl" data-i18n="girl_voice">صوت بنت</option>
                        <option value="child" data-i18n="child_voice">صوت طفل</option>
                    </select>
                </div>
                <button id="alphabet-press-play-audio-sidebar" class="control-button">🔊 استمع</button>
            </div>
        </div>

        <div id="memory-game-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">🃏 إعدادات لعبة الذاكرة</h3>
            <div class="sidebar-game-controls memory-game-controls">
                <div class="control-group">
                    <h3>اختر اللغة:</h3>
                    <button id="memory-game-lang-ar" class="memory-game-lang-button active">العربية</button>
                    <button id="memory-game-lang-en" class="memory-game-lang-button">English</button>
                </div>
                <div class="control-group topic-selection">
                    <h3>اختر الموضوع:</h3>
                </div>
                <div class="control-group play-mode-selection">
                    <h3>نمط اللعب:</h3>
                    <button id="memory-game-mode-image-image" class="memory-game-mode-button active">صورة - صورة</button>
                    <button id="memory-game-mode-image-word" class="memory-game-mode-button">صورة - كلمة</button>
                    <button id="memory-game-mode-image-char" class="memory-game-mode-button">صورة - حرف</button>
                    <button id="memory-game-mode-image-audio" class="memory-game-mode-button">صورة - صوت</button>
                </div>
                <button id="memory-game-start-button" class="memory-game-start-button">ابدأ اللعب</button>
            </div>
        </div>

        <div class="sidebar-section static-section">
          <h3>👤 حسابك</h3>
          <ul>
            <li><a href="#" onclick="loadLogin()">تسجيل الدخول</a></li>
            <li><a href="#" onclick="loadRegister()">تسجيل جديد</a></li>
            <li><a href="#" onclick="loadProfile()">الملف الشخصي</a></li>
            <li><a href="/users/my-report.html">سجل النقاط</a></li>
          </ul>
        </div>
      </aside>

      <main class="main-content">
        <h2 id="welcome-message" style="display: block;">مرحبًا بك في الموسوعة!</h2>
        <div id="home-topic-cards" class="home-cards-container">
            <a href="#" class="topic-card animals" onclick="loadAnimalsPage(); return false;">
                <span class="icon">🐾</span>
                <h3>الحيوانات</h3>
            </a>
            <a href="#" class="topic-card fruits" onclick="loadFruitsPage(); return false;">
                <span class="icon">🍎</span>
                <h3>الفواكه</h3>
            </a>
            <a href="#" class="topic-card vegetables" onclick="loadVegetablesPage(); return false;">
                <span class="icon">🥦</span>
                <h3>الخضروات</h3>
            </a>
            <a href="#" class="topic-card human-body" onclick="loadHumanBodyPage(); return false;"> <span class="icon">🧠</span>
                <h3>جسم الإنسان</h3>
            </a>
            <a href="#" class="topic-card games" onclick="loadAlphabetPressPage(); return false;">
                <span class="icon">🔠</span>
                <h3>لعبة الحروف</h3> </a>
            <a href="#" class="topic-card games" onclick="loadMemoryGamePage(); return false;">
                <span class="icon">🧠</span>
                <h3>لعبة الذاكرة</h3>
            </a>
        </div>
      </main>
    </div>
  </div>

  <script type="module">
    import { showProfileForm } from '/src/js/profile.js';
    import { loadAnimalsGameContent, showNextAnimal, showPreviousAnimal, playCurrentAnimalAudio } from '/src/js/animals-game.js';
    import { loadFruitsGameContent, showNextFruit, showPreviousFruit, playCurrentFruitAudio } from '/src/js/fruits-game.js';
    import { loadVegetablesGameContent, showNextVegetable, showPreviousVegetable, playCurrentVegetableAudio } from '/src/js/vegetables-game.js';
    import { loadHumanBodyGameContent, showNextHumanBodyPart, showPreviousHumanBodyPart, playCurrentHumanBodyPartAudio } from '/src/js/human-body-game.js';
    import { setDirection, currentLang, loadLanguage, applyTranslations } from '/src/js/lang-handler.js';
	
    import {
        loadAlphabetPressGameContent,
        playCurrentAlphabetItemAudioFromSidebar,
        getCurrentDisplayedItem,
        handleAlphabetPressLanguageChange,
        handleAlphabetPressCategoryChange,
        updateAlphabetPressVoice,
        populateAlphabetPressSidebarOptions
    } from '/src/js/alphabet-press-game.js';

    import {
        loadMemoryGameContent,
        initializeMemoryGameSidebarControls
    } from '/src/js/memory-game.js';


    const mainContentArea = document.querySelector("main.main-content");
    const animalSidebarControls = document.getElementById("animal-sidebar-controls");
    const fruitSidebarControls = document.getElementById("fruit-sidebar-controls");
    const vegetableSidebarControls = document.getElementById("vegetable-sidebar-controls");
    const humanBodySidebarControls = document.getElementById("human-body-sidebar-controls");
    const alphabetPressSidebarControls = document.getElementById("alphabet-press-sidebar-controls");
    const memoryGameSidebarControls = document.getElementById("memory-game-sidebar-controls"); 

    const welcomeMessage = document.getElementById("welcome-message");
    const homeTopicCards = document.getElementById("home-topic-cards");

    window.loadLogin = async () => {
        hideAllControls();
        try {
            const response = await fetch('/users/login-form.html');
            if (!response.ok) throw new Error('Failed to load login form');
            const loginFormHtml = await response.text();
            mainContentArea.innerHTML = loginFormHtml;
        } catch (error) {
            console.error('Error loading login form:', error);
            mainContentArea.innerHTML = '<p style="color: red;">تعذر تحميل نموذج تسجيل الدخول. يرجى المحاولة لاحقاً.</p>';
        }
    };

    window.loadRegister = async () => {
        hideAllControls();
        try {
            const response = await fetch('/users/register-form.html');
            if (!response.ok) throw new Error('Failed to load register form');
            const registerFormHtml = await response.text();
            mainContentArea.innerHTML = registerFormHtml;
        } catch (error) {
            console.error('Error loading register form:', error);
            mainContentArea.innerHTML = '<p style="color: red;">تعذر تحميل نموذج التسجيل. يرجى المحاولة لاحقاً.</p>';
        }
    };

    window.loadProfile = () => { showProfileForm(); hideAllControls(); };

    window.loadAnimalsPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      await loadAnimalsGameContent();
      showAnimalControls();
      initializeSubjectControls('animal');
    };

    window.loadFruitsPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      await loadFruitsGameContent();
      showFruitControls();
      initializeSubjectControls('fruit');
    };

    window.loadVegetablesPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      await loadVegetablesGameContent();
      showVegetableControls();
      initializeSubjectControls('vegetable');
    };

    window.loadHumanBodyPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      await loadHumanBodyGameContent();
      showHumanBodyControls();
      initializeSubjectControls('human-body');
    };

    // دالة تحميل صفحة لعبة اضغط على الحرف
    window.loadAlphabetPressPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      
      await loadAlphabetPressGameContent(); // يتم حقن محتوى اللعبة في main-content
      showAlphabetPressControls(); // إظهار عناصر التحكم الخاصة باللعبة في الشريط الجانبي

      // *** استدعاء دالة تهيئة الخيارات من alphabet-press-game.js مباشرةً هنا ***
      await populateAlphabetPressSidebarOptions(); // تم تغيير اسم الدالة وستقوم هي بتهيئة المستمعين

    };

    // دالة تحميل صفحة لعبة الذاكرة
    window.loadMemoryGamePage = async () => {
        hideAllControls();
        if (welcomeMessage) welcomeMessage.style.display = 'none';
        if (homeTopicCards) homeTopicCards.style.display = 'none';
        
        // قم بتهيئة عناصر التحكم في الشريط الجانبي أولاً
        if (memoryGameSidebarControls) {
            await initializeMemoryGameSidebarControls();
            showMemoryGameControls();
        } else {
            console.error("Memory game sidebar controls not found. Cannot initialize.");
        }

        await loadMemoryGameContent(); 
    };

    window.showHomePage = () => {
        mainContentArea.innerHTML = `
            <h2 id="welcome-message-inner" style="display: block;">مرحبًا بك في الموسوعة!</h2>
            <div id="home-topic-cards-inner" class="home-cards-container">
                <a href="#" class="topic-card animals" onclick="loadAnimalsPage(); return false;">
                    <span class="icon">🐾</span>
                    <h3>الحيوانات</h3>
                </a>
                <a href="#" class="topic-card fruits" onclick="loadFruitsPage(); return false;">
                    <span class="icon">🍎</span>
                    <h3>الفواكه</h3>
                </a>
                <a href="#" class="topic-card vegetables" onclick="loadVegetablesPage(); return false;">
                    <span class="icon">🥦</span>
                    <h3>الخضروات</h3>
                </a>
                <a href="#" class="topic-card human-body" onclick="loadHumanBodyPage(); return false;">
                    <span class="icon">🧠</span>
                    <h3>جسم الإنسان</h3>
                </a>
                <a href="#" class="topic-card games" onclick="loadAlphabetPressPage(); return false;">
                    <span class="icon">🔠</span>
                    <h3>لعبة الحروف</h3> </a>
                <a href="#" class="topic-card games" onclick="loadMemoryGamePage(); return false;">
                    <span class="icon">🧠</span>
                    <h3>لعبة الذاكرة</h3>
                </a>
            </div>
        `;
        hideAllControls();

        const defaultLang = localStorage.getItem("lang") || "ar";
        setDirection(defaultLang);
    };

    function showAnimalControls() { if (animalSidebarControls) { animalSidebarControls.style.display = 'block'; } }
    function hideAnimalControls() { if (animalSidebarControls) { animalSidebarControls.style.display = 'none'; } }
    function showFruitControls() { if (fruitSidebarControls) { fruitSidebarControls.style.display = 'block'; } }
    function hideFruitControls() { if (fruitSidebarControls) { fruitSidebarControls.style.display = 'none'; } }
    function showVegetableControls() { if (vegetableSidebarControls) { vegetableSidebarControls.style.display = 'block'; } }
    function hideVegetableControls() { if (vegetableSidebarControls) { vegetableSidebarControls.style.display = 'none'; } }
    function showHumanBodyControls() { if (humanBodySidebarControls) { humanBodySidebarControls.style.display = 'block'; } }
    function hideHumanBodyControls() { if (humanBodySidebarControls) { humanBodySidebarControls.style.display = 'none'; } }
    function showAlphabetPressControls() { if (alphabetPressSidebarControls) { alphabetPressSidebarControls.style.display = 'block'; } }
    function hideAlphabetPressControls() { if (alphabetPressSidebarControls) { alphabetPressSidebarControls.style.display = 'none'; } }
    function showMemoryGameControls() { if (memoryGameSidebarControls) { memoryGameSidebarControls.style.display = 'block'; } }
    function hideMemoryGameControls() { if (memoryGameSidebarControls) { memoryGameSidebarControls.style.display = 'none'; } }


    function hideAllControls() {
        hideAnimalControls();
        hideFruitControls();
        hideVegetableControls();
        hideHumanBodyControls();
        hideAlphabetPressControls();
        hideMemoryGameControls();
    }

    const availableCategories = [
        { id: 'animals', name_ar: 'حيوانات', name_en: 'Animals', name_he: 'חיות' },
        { id: 'fruits', name_ar: 'فواكه', name_en: 'Fruits', name_he: 'פירות' },
        { id: 'vegetables', name_ar: 'خضروات', name_en: 'Vegetables', name_he: 'ירقات' },
        { id: 'human-body', name_ar: 'جسم الإنسان', name_en: 'Human Body', name_he: 'גוף האדם' },
    ];

    // دالة initializeSubjectControls العامة لتهيئة عناصر التحكم لكل موضوع
    async function initializeSubjectControls(subjectType) {
        let langSelect, voiceSelect, playSoundBtn, prevBtn, nextBtn;
        let loadContentFunc, showNextFunc, showPrevFunc, playAudioFunc;

        switch(subjectType) {
            case 'animal':
                langSelect = document.getElementById('game-lang-select-animal');
                voiceSelect = document.getElementById('voice-select-animal');
                playSoundBtn = document.getElementById('play-sound-btn-animal');
                prevBtn = document.getElementById('prev-animal-btn');
                nextBtn = document.getElementById('next-animal-btn');
                loadContentFunc = loadAnimalsGameContent;
                showNextFunc = showNextAnimal;
                showPrevFunc = showPreviousAnimal;
                playAudioFunc = playCurrentAnimalAudio;
                break;
            case 'fruit':
                langSelect = document.getElementById('game-lang-select-fruit');
                voiceSelect = document.getElementById('voice-select-fruit');
                playSoundBtn = document.getElementById('play-sound-btn-fruit');
                prevBtn = document.getElementById('prev-fruit-btn');
                nextBtn = document.getElementById('next-fruit-btn');
                loadContentFunc = loadFruitsGameContent;
                showNextFunc = showNextFruit;
                showPrevFunc = showPreviousFruit;
                playAudioFunc = playCurrentFruitAudio;
                break;
            case 'vegetable':
                langSelect = document.getElementById('game-lang-select-vegetable');
                voiceSelect = document.getElementById('voice-select-vegetable');
                playSoundBtn = document.getElementById('play-sound-btn-vegetable');
                prevBtn = document.getElementById('prev-vegetable-btn');
                nextBtn = document.getElementById('next-vegetable-btn');
                loadContentFunc = loadVegetablesGameContent;
                showNextFunc = showNextVegetable;
                showPrevFunc = showPreviousVegetable;
                playAudioFunc = playCurrentVegetableAudio;
                break;
            case 'human-body':
                langSelect = document.getElementById('game-lang-select-human-body');
                voiceSelect = document.getElementById('voice-select-human-body');
                playSoundBtn = document.getElementById('play-sound-btn-human-body');
                prevBtn = document.getElementById('prev-human-body-btn');
                nextBtn = document.getElementById('next-human-body-btn');
                loadContentFunc = loadHumanBodyGameContent;
                showNextFunc = showNextHumanBodyPart;
                showPrevFunc = showPreviousHumanBodyPart;
                playAudioFunc = playCurrentHumanBodyPartAudio;
                break;
            default:
                return;
        }

        if (!langSelect || !voiceSelect) {
            console.error(`عناصر التحكم لنوع الموضوع '${subjectType}' لم يتم العثور عليها في DOM.`);
            return;
        }

        if (langSelect.options.length === 0) {
            ['ar', 'en', 'he'].forEach(langCode => {
                const option = document.createElement('option');
                option.value = langCode;
                option.textContent = { 'ar': 'العربية', 'en': 'English', 'he': 'עברית' }[langCode];
                langSelect.appendChild(option);
            });
            langSelect.value = currentLang;
        }

        if (voiceSelect.options.length === 0) {
            ['teacher', 'boy', 'girl', 'child'].forEach(voiceType => {
                const option = document.createElement('option');
                option.value = voiceType;
                option.textContent = { 'teacher': 'المعلم', 'boy': 'صوت ولد', 'girl': 'صوت بنت', 'child': 'صوت طفل' }[voiceType];
                voiceSelect.appendChild(option);
            });
            voiceSelect.value = 'teacher';
        }

        langSelect.onchange = async () => {
            const newLang = langSelect.value;
            await loadLanguage(newLang);
            applyTranslations();
            setDirection(newLang);
            await loadContentFunc();
        };

        voiceSelect.onchange = () => {
            // منطق تحديث الصوت في ملف اللعبة الخاص بالموضوع (مثل animals-game.js)
            // هذه الأزرار لا تمرر القيمة مباشرة إلى الدالة، بل الدالة تستخدم قيمة الـ select
            // ولذلك لا حاجة لدالة update هنا
        };

        if (playSoundBtn) playSoundBtn.onclick = () => {
            playAudioFunc();
        };

        if (prevBtn) prevBtn.onclick = () => {
            showPrevFunc();
        };

        if (nextBtn) nextBtn.onclick = () => {
            showNextFunc();
        };

        applyTranslations();
    }


    document.addEventListener('DOMContentLoaded', () => {
        window.showHomePage();
    });
  </script>
</body>
</html>
تمام، سأقوم بتحليل لقطتي الشاشة والملفات المرفقة (خاصة `index.html` و `memory-game.js` و `alphabet-press-game.js`) ومعالجة الأخطاء المتبقية.

**ملخص الأخطاء الحالية:**

1.  **لعبة اضغط على الحرف:** `Failed to get references for alphabet press sidebar controls.` (لا تزال أزرار الشريط الجانبي لا تظهر).
2.  **لعبة الذاكرة:** `Missing or Insufficient permissions` من Firestore (لا تزال البطاقات لا تظهر).
3.  **لعبة الذاكرة:** `ReferenceError: currentLanguage is not defined` (هذا الخطأ لا يزال موجودًا).

---

## تحليل وحلول مفصلة:

### 1. **خطأ "لعبة الحروف" (Sidebar Controls Not Found):**

* **المشكلة:** الخطأ `Failed to get references for alphabet press sidebar controls.` يحدث لأن الكود في `index.html` يحاول الوصول إلى عناصر مثل `alphabet-press-language-select` قبل أن يتمكن المتصفح من إيجادها في الـ DOM، حتى بعد استدعاء `showAlphabetPressControls()`. المشكلة في توقيت الوصول للعناصر داخل كتلة `script type="module"` الرئيسية في `index.html`.
* **الحل:**
    * الدالة `populateAlphabetPressSidebarOptions()` في `alphabet-press-game.js` هي المسؤولة عن الحصول على مراجع هذه العناصر وربط المستمعين بها. يجب أن تُستدعى هذه الدالة **فقط بعد أن تكون عناصر الشريط الجانبي هذه متوفرة تمامًا في الـ DOM ويمكن الوصول إليها**.
    * الحل هو التأكد من أن هذه العناصر موجودة ومرئية في الـ DOM عند استدعاء `populateAlphabetPressSidebarOptions()`. بما أن هذه العناصر موجودة في HTML الثابت لـ `index.html` وتكون مخفية افتراضيًا، فإن إظهار `alphabetPressSidebarControls` أولاً سيجعلها متاحة للوصول.

    **التعديل في `public/index.html` (الجزء الخاص بـ `window.loadAlphabetPressPage`):**
    ```html
    // دالة تحميل صفحة لعبة اضغط على الحرف
    window.loadAlphabetPressPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      
      showAlphabetPressControls(); // *** اجعل عناصر الشريط الجانبي مرئية أولاً ***
      // الآن، وبعد أن أصبحت مرئية، استدعِ الدالة التي تبحث عنها وتهيئها
      await populateAlphabetPressSidebarOptions(); 

      // ثم قم بتحميل محتوى اللعبة في المنطقة الرئيسية
      await loadAlphabetPressGameContent(); 
    };
    ```
    * **ملاحظة هامة جداً:** تأكد من أن هذه العناصر (`alphabet-press-language-select` و `alphabet-press-category-select` وغيرها) موجودة في `index.html` بشكل مباشر ضمن `div` الأب `alphabet-press-sidebar-controls`، وليس يتم حقنها ديناميكيًا من مكان آخر. الـ HTML في ملف `index.html` المرفق يُظهر أنها موجودة بشكل مباشر، وهذا جيد.

### 2. **خطأ "الذاكرة" - `Missing or Insufficient permissions` (Firestore):**

* **المشكلة:** الخطأ `Missing or Insufficient permissions` يعني أن Firebase Firestore يرفض طلب جلب البيانات. هذا لا يزال يشير إلى مشكلة في **قواعد أمان Firebase Firestore** أو عدم تطبيقها بشكل صحيح. لقطة الشاشة "image_7f3ddd.png" تُظهر أن القاعدة `allow read: if true;` موجودة، ولكن الخطأ لا يزال يحدث.
* **الحلول المتبقية:**
    1.  **النشر مرة أخرى بقوة:** ارجع إلى Firebase Console -> Firestore Database -> Rules. انقر على **"Publish" مرة أخرى**. في بعض الأحيان، يمكن أن تكون هناك مشكلات مؤقتة في النشر.
    2.  **تحقق من لوحة "Network":** في أدوات المطور (F12) في المتصفح، انتقل إلى علامة التبويب `Network`.
        * أعد تحميل الصفحة وانقر على "الذاكرة".
        * ابحث عن طلبات `firestore.googleapis.com`. انقر عليها.
        * ما هو **رمز الحالة (Status Code)** الذي تحصل عليه (مثلاً 200 OK، 403 Forbidden)؟
        * ماذا يظهر في علامة التبويب **"Response"** أو **"Preview"** للطلب؟ هل هناك رسالة خطأ أكثر تفصيلاً من Firebase؟ هذا سيساعدنا في تحديد ما إذا كانت المشكلة في الأذونات نفسها أو في شيء آخر (مثل أن المسار الذي يطلبه الكود غير موجود بالفعل في قاعدة البيانات).
    3.  **التحقق من البيانات الفعلية:** في Firebase Console -> Firestore Database -> Data، تأكد أنك تملك فعلاً:
        * `categories` (مجموعة)
        * داخلها مستندات مثل `animals`, `fruits` (كل منها كـ Document).
        * داخل كل مستند، مجموعة فرعية تسمى `items`.
        * داخل `items`، مستندات لكل عنصر (مثلاً `bear`, `apple`).
        * وأن هذه المستندات تحتوي على الحقول المطلوبة (مثل `name`, `image`, `letter`, `voices`) بنفس الترتيب الذي تتوقعه في الكود.

### 4. **خطأ "الذاكرة" - `ReferenceError: currentLanguage is not defined`:**

* **المشكلة:** هذا الخطأ يعني أن المتغير `currentLanguage` لم يعد معرفًا في النطاق الذي يستخدم فيه. في التعديلات السابقة، قمنا بتحويل جميع استخدامات `currentLanguage` إلى `currentLang` (المستورد من `lang-handler.js`). يبدو أن هناك مكانًا واحدًا أو أكثر لم يتم تحديثه.
* **الحل:** سأقوم بمراجعة شاملة لملف `memory-game.js` الخاص بك مرة أخرى، مع التركيز بشكل خاص على جميع مثيلات `currentLanguage` والتأكد من استبدالها بـ `currentLang`.

---

## مراجعة `public/js/memory-game.js` (للتأكد من `currentLang`):

سأقدم لك النسخة النهائية لملف `memory-game.js` مع التأكد من استخدام `currentLang` في كل مكان بدلاً من `currentLanguage`.

```javascript
// E:\cyclopedia\src\js\memory-game.js (تأكيد المسار: src/js/)

import { db } from './firebase-config.js';
import { collection, getDocs } from 'firebase/firestore';
import { currentLang, loadLanguage, applyTranslations, setDirection } from './lang-handler.js'; // استيراد currentLang
import { playAudio, stopCurrentAudio } from './audio-handler.js';
import { recordActivity } from './activity-handler.js';

// المتغيرات التي ستستخدم عبر اللعبة، معرفة في النطاق العلوي للوحدة
let gameBoard;
let startGameButton;
let langButtons;
let topicButtons = []; 
let modeButtons;
let gameStatusDisplay;

let cards = [];
let flippedCards = [];
let matchedPairs = 0;
let lockBoard = false;

let allCardData = {}; 
let currentTopic = 'animals'; 
let currentPlayMode = 'image-image'; 

// هذه الدالة ستُستدعى من index.html لتحميل محتوى اللعبة وتهيئته
export async function loadMemoryGameContent() {
    console.log('جارٍ تحميل محتوى لعبة الذاكرة...');

    const mainContentArea = document.querySelector('.main-content');
    // تأكد أن الهيكل الرئيسي للعبة (game-board, game-status) سيُحقن هنا
    // إذا كان هناك مشاكل في ظهورها، فقد تكون المشكلة هنا
    mainContentArea.innerHTML = `
        <h1>لعبة الذاكرة</h1>
        <div class="memory-game-grid" id="memory-game-board">
            </div>
        <div class="game-status" id="memory-game-status">
            </div>
    `;

    // الحصول على مراجع عناصر الـ DOM بعد حقن الـ HTML
    // هذا أمر حاسم، تأكد من أن هذه العناصر موجودة فعلاً بعد الـ innerHTML
    gameBoard = document.getElementById('memory-game-board');
    gameStatusDisplay = document.getElementById('memory-game-status');
    
    // جلب البيانات وبناء اللوحة لأول مرة
    // يتم استدعاء populateTopicButtons و createBoard داخل fetchCardData
    await fetchCardData();
}

// دالة تهيئة عناصر التحكم في الشريط الجانبي للعبة الذاكرة
// هذه الدالة ستُستدعى من index.html ويجب أن تهتم فقط بعناصر الشريط الجانبي
export async function initializeMemoryGameSidebarControls() {
    // الحصول على مراجع الأزرار في الشريط الجانبي بعد أن تكون موجودة في الـ DOM
    // تأكد من أن هذه IDs والفئات موجودة في HTML ملف index.html
    startGameButton = document.getElementById('memory-game-start-button');
    langButtons = document.querySelectorAll('.memory-game-lang-button');
    modeButtons = document.querySelectorAll('.memory-game-mode-button');

    // تهيئة المستمعين للأحداث لعناصر التحكم في الشريط الجانبي
    setupEventListeners();
    
    // بعد تهيئة أزرار اللغة، تأكد من تحديث حالتها بناءً على currentLang العالمية
    // currentLang هو المتغير المستورد من lang-handler
    langButtons.forEach(button => {
        if (button.id === `memory-game-lang-${currentLang}`) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });

    // Populate topic buttons if data is already fetched
    // هذا يسمح لـ populateTopicButtons بالعمل حتى لو تم استدعاؤها مبكرًا
    if (Object.keys(allCardData).length > 0) {
        populateTopicButtons();
    }
}


function setupEventListeners() {
    // إزالة المستمعين القدامى قبل إضافة الجدد لتجنب التكرار
    if (startGameButton) {
        startGameButton.removeEventListener('click', createBoard);
        startGameButton.addEventListener('click', createBoard);
    }

    if (langButtons) {
        langButtons.forEach(button => {
            button.removeEventListener('click', handleLanguageChange);
            button.addEventListener('click', handleLanguageChange);
        });
    }

    if (modeButtons) {
        modeButtons.forEach(button => {
            button.removeEventListener('click', handleModeChange);
            button.addEventListener('click', handleModeChange);
        });
    }
}

function handleLanguageChange(event) {
    langButtons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    // تحديث currentLang العالمية باستخدام دالة loadLanguage من lang-handler
    loadLanguage(event.target.id === 'memory-game-lang-ar' ? 'ar' : 'en').then(() => {
        // بعد تحديث اللغة العالمية، قم بتحديث نصوص البطاقات المحلية في اللعبة
        updateCardTexts();
        // أيضاً، قم بإعادة بناء لوحة اللعبة لتطبيق اللغة على البطاقات الجديدة (إن لم يكن هناك لعبة نشطة)
        // إذا كان المستخدم يغير اللغة في منتصف اللعبة، updateCardTexts تكفي.
        // إذا كان يغيرها قبل البدء، فـ createBoard سيطبقها.
    });
}

function handleModeChange(event) {
    modeButtons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    currentPlayMode = event.target.id.replace('memory-game-mode-', '');
    createBoard(); // إعادة إنشاء اللوحة بالنمط الجديد
}


async function fetchCardData() {
    if (!db) {
        console.error("Firestore DB not initialized. Cannot fetch data.");
        // استخدام currentLang هنا
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'فشل إعداد قاعدة البيانات.' : 'Database setup failed.');
        return;
    }

    try {
        const categoriesSnapshot = await getDocs(collection(db, "categories"));
        
        const categoriesData = {};
        for (const doc of categoriesSnapshot.docs) {
            const categoryName = doc.id;
            const itemsCollectionRef = collection(db, "categories", categoryName, "items");
            const itemsSnapshot = await getDocs(itemsCollectionRef);
            
            categoriesData[categoryName] = itemsSnapshot.docs.map(itemDoc => {
                const data = itemDoc.data();
                return {
                    id: itemDoc.id,
                    image_name: data.image,
                    name_ar: data.name.ar,
                    name_en: data.name.en,
                    letter_ar: data.letter ? data.letter.ar : '',
                    letter_en: data.letter ? data.letter.en : '',
                    audio_ar: data.voices && data.voices.ar ? data.voices.ar : '',
                    audio_en: data.voices && data.voices.en ? data.voices.en : '',
                };
            });
        }
        allCardData = categoriesData;
        
        // بمجرد جلب البيانات، قم بتهيئة أزرار المواضيع
        populateTopicButtons(); 
        createBoard(); // بناء اللوحة لأول مرة
        
    } catch (error) {
        console.error('فشل في جلب بيانات البطاقات من Firestore:', error);
        // استخدام currentLang هنا
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'فشل تحميل البيانات. تحقق من اتصال الإنترنت.' : 'Failed to load data. Check internet connection.');
    }
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function createBoard() {
    // التأكد من أن gameBoard قد تم الحصول على مرجعه
    if (!gameBoard) {
        console.error("Game board element not found in createBoard.");
        return;
    }
    gameBoard.innerHTML = '';
    gameStatusDisplay.textContent = '';

    flippedCards = [];
    matchedPairs = 0;
    lockBoard = false;

    // استخدام currentTopic
    const selectedTopicItems = allCardData[currentTopic];
    if (!selectedTopicItems || selectedTopicItems.length < 6) {
        console.warn(`لا توجد بيانات كافية للموضوع ${currentTopic} أو الموضوع غير موجود.`);
        // استخدام currentLang هنا
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'لا توجد بيانات كافية لهذا الموضوع.' : 'Not enough data for this topic.');
        return;
    }

    const shuffledTopicItems = shuffleArray([...selectedTopicItems]);
    const chosenItems = shuffledTopicItems.slice(0, 6);

    const gameCardsForMode = [];

    chosenItems.forEach(item => {
        if (currentPlayMode === 'image-image') {
            gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
            gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
        }
        else if (currentPlayMode === 'image-word') {
            gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
            // استخدام currentLang هنا
            gameCardsForMode.push({ type: 'word', value: (currentLang === 'ar' ? item.name_ar : item.name_en), id: item.id, text_ar: item.name_ar, text_en: item.name_en });
        }
        else if (currentPlayMode === 'image-char') {
            if (item.letter_ar && item.letter_en) {
                gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
                // استخدام currentLang هنا
                gameCardsForMode.push({ type: 'char', value: (currentLang === 'ar' ? item.letter_ar : item.letter_en), id: item.id, text_ar: item.name_ar, text_en: item.name_en });
            } else {
                console.warn(`لا يوجد حرف لـ ${item.id} في الموضوع ${currentTopic}. سيتم تخطي هذا العنصر لهذا النمط.`);
            }
        }
        else if (currentPlayMode === 'image-audio') {
            if (item.audio_ar && item.audio_en) {
                gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
                // استخدام currentLang هنا
                gameCardsForMode.push({ type: 'audio', value: `audio/${currentLang}/${currentTopic}/${currentLang === 'ar' ? item.audio_ar : item.audio_en}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en, image_url_for_audio_card: `images/${currentTopic}/${item.image_name}` });
            } else {
                console.warn(`لا يوجد صوت لـ ${item.id} في الموضوع ${currentTopic}. سيتم تخطي هذا العنصر لهذا النمط.`);
            }
        }
    });

    if (gameCardsForMode.length < 12) {
         // استخدام currentLang هنا
         gameStatusDisplay.textContent = (currentLang === 'ar' ? 'لا توجد عناصر كافية لهذا النمط والموضوع.' : 'Not enough items for this mode and topic.');
         console.error("Not enough cards generated for the selected mode.");
         return;
    }

    const shuffledCards = shuffleArray(gameCardsForMode);

    shuffledCards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.classList.add('memory-card');
        cardElement.dataset.cardId = card.id;
        cardElement.dataset.cardType = card.type;

        let frontContent = '';
        // استخدام currentLang هنا
        let cardText = currentLang === 'ar' ? card.text_ar : card.text_en;

        if (card.type === 'image') {
            frontContent = `<img src="${card.value}" alt="${card.id}">`;
        } else if (card.type === 'word' || card.type === 'char') {
            frontContent = `<span class="card-display-text">${card.value}</span>`;
        } else if (card.type === 'audio') {
            frontContent = `
                <img src="${card.image_url_for_audio_card}" alt="${card.id}">
                <audio src="${card.value}" preload="auto"></audio>
                <button class="play-audio-btn">▶</button>
            `;
        }

        cardElement.innerHTML = `
            <div class="front-face">
                ${frontContent}
                <span class="card-text">${cardText}</span>
            </div>
            <div class="back-face"></div>
        `;
        
        if (card.type === 'audio') {
            const playButton = cardElement.querySelector('.play-audio-btn');
            if (playButton) {
                playButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const audio = cardElement.querySelector('audio');
                    if (audio) {
                        playAudio(audio.src);
                    }
                });
            }
        }

        cardElement.addEventListener('click', flipCard);
        gameBoard.appendChild(cardElement);
    });

    cards = document.querySelectorAll('.memory-card');
}

function flipCard() {
    if (lockBoard) return;
    if (this === flippedCards[0]) return;

    this.classList.add('flipped');
    flippedCards.push(this);

    if (flippedCards.length === 2) {
        lockBoard = true;
        checkForMatch();
    }
}

function checkForMatch() {
    const [firstCard, secondCard] = flippedCards;
    const firstCardId = firstCard.dataset.cardId;
    const secondCardId = secondCard.dataset.cardId;
    const firstCardType = firstCard.dataset.cardType;
    const secondCardType = secondCard.dataset.cardType;

    let isMatch = false;

    if (firstCardId === secondCardId) {
        if (currentPlayMode === 'image-image') {
            isMatch = (firstCardType === 'image' && secondCardType === 'image');
        } else if (currentPlayMode === 'image-word') {
            isMatch = (
                (firstCardType === 'image' && secondCardType === 'word') ||
                (firstCardType === 'word' && secondCardType === 'image')
            );
        } else if (currentPlayMode === 'image-char') {
             isMatch = (
                (firstCardType === 'image' && secondCardType === 'char') ||
                (firstCardType === 'char' && secondCardType === 'image')
            );
        } else if (currentPlayMode === 'image-audio') {
             isMatch = (
                (firstCardType === 'image' && secondCardType === 'audio') ||
                (firstCardType === 'audio' && secondCardType === 'image')
            );
        }
    }

    if (isMatch) {
        disableCards();
        matchedPairs++;
        // استخدام currentLang هنا
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'لقد وجدت زوجًا!' : 'You found a pair!');
        const currentUser = JSON.parse(localStorage.getItem("user"));
        if (currentUser) {
            recordActivity(currentUser, currentTopic);
        }

        if (matchedPairs === 6) {
            setTimeout(() => {
                // استخدام currentLang هنا
                gameStatusDisplay.textContent = (currentLang === 'ar' ? 'تهانينا! لقد فزت باللعبة!' : 'Congratulations! You won the game!');
            }, 500);
        }
    } else {
        unflipCards();
        // استخدام currentLang هنا
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'حاول مرة أخرى.' : 'Try again.');
    }
}

function disableCards() {
    flippedCards.forEach(card => {
        card.removeEventListener('click', flipCard);
        card.classList.add('matched');
    });
    resetBoard();
}

function unflipCards() {
    setTimeout(() => {
        flippedCards.forEach(card => card.classList.remove('flipped'));
        resetBoard();
    }, 1000);
}

function resetBoard() {
    [flippedCards, lockBoard] = [[], false];
}

function updateCardTexts() {
    cards.forEach(cardElement => {
        const cardId = cardElement.dataset.cardId;
        const cardType = cardElement.dataset.cardType;
        const topicItems = allCardData[currentTopic];
        const originalItem = topicItems ? topicItems.find(data => data.id === cardId) : null;

        if (originalItem) {
            const cardTextSpan = cardElement.querySelector('.card-text');
            if (cardTextSpan) {
                // استخدام currentLang هنا
                cardTextSpan.textContent = currentLang === 'ar' ? originalItem.name_ar : originalItem.name_en;
            }

            if (cardType === 'word') {
                 const displaySpan = cardElement.querySelector('.card-display-text');
                 // استخدام currentLang هنا
                 if(displaySpan) displaySpan.textContent = currentLang === 'ar' ? originalItem.name_ar : originalItem.name_en;
            } else if (cardType === 'char') {
                const displaySpan = cardElement.querySelector('.card-display-text');
                // استخدام currentLang هنا
                if(displaySpan) displaySpan.textContent = currentLang === 'ar' ? originalItem.letter_ar : originalItem.letter_en;
            } else if (cardType === 'audio') {
                const audioElem = cardElement.querySelector('audio');
                // استخدام currentLang هنا (تحديث مسار الصوت)
                if(audioElem) audioElem.src = `audio/${currentLang}/${currentTopic}/${currentLang === 'ar' ? originalItem.audio_ar : originalItem.audio_en}`;
            }
        }
    });
}

const topicSelectionDiv = document.querySelector('#memory-game-sidebar-controls .topic-selection');
export function populateTopicButtons() {
    // التأكد من أن topicSelectionDiv موجود قبل محاولة التفاعل معه
    if (!topicSelectionDiv) {
        console.error("Topic selection div not found in memory game sidebar controls for populateTopicButtons.");
        return;
    }
    topicSelectionDiv.innerHTML = '<h3>اختر الموضوع:</h3>';

    const categories = Object.keys(allCardData);
    
    const sidebarTopicButtons = [];

    categories.forEach(topicKey => {
        const button = document.createElement('button');
        button.id = `memory-game-topic-${topicKey}`;
        button.classList.add('memory-game-topic-button');
        button.textContent = topicKey.charAt(0).toUpperCase() + topicKey.slice(1);

        if (topicKey === currentTopic) {
            button.classList.add('active');
        }

        button.addEventListener('click', () => {
            // استخدام نطاق أكثر تحديدًا للبحث عن الأزرار
            document.querySelectorAll('#memory-game-sidebar-controls .memory-game-topic-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentTopic = topicKey;
            createBoard();
        });
        topicSelectionDiv.appendChild(button);
        sidebarTopicButtons.push(button);
    });
    topicButtons = sidebarTopicButtons;
}
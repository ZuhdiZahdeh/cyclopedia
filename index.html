<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ù…ÙˆØ³ÙˆØ¹Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ø£Ø·ÙØ§Ù„</title>

  <link rel="stylesheet" href="/css/colors.css" />
  <link rel="stylesheet" href="/css/fonts.css" />
  <link rel="stylesheet" href="/css/shared-utilities.css" />
  <link rel="stylesheet" href="/css/home.css" />
  <link rel="stylesheet" href="/css/forms.css" />
  <link rel="stylesheet" href="/css/common-components-subjects.css" />
  <link rel="stylesheet" href="/css/animals.css" />
  <link rel="stylesheet" href="/css/fruits.css" />
  <link rel="stylesheet" href="/css/vegetables.css" />
  <link rel="stylesheet" href="/css/human-body.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/alphabet-press.css" />
  <link rel="stylesheet" href="/css/memory-game.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
  <div id="app">
    <header class="top-navbar shadow">
      <nav class="top-nav-links">
        <a href="#" onclick="showHomePage()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="#" onclick="loadAnimalsPage()">ğŸ“š Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</a>
        <a href="#" onclick="loadFruitsPage()">ğŸ Ø§Ù„ÙÙˆØ§ÙƒÙ‡</a>
        <a href="#" onclick="loadVegetablesPage()">ğŸ¥¦ Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª</a>
        <a href="#" onclick="loadHumanBodyPage()">ğŸ§  Ø¬Ø³Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù†</a>
        <a href="#" onclick="loadAlphabetPressPage()">ğŸ® Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø±ÙˆÙ</a> <a href="#" onclick="loadMemoryGamePage()">ğŸƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</a>
      </nav>
    </header>

    <div class="page-layout">
      <aside class="sidebar shadow">
        <div id="animal-sidebar-controls" class="sidebar-section" style="display: none;">
          <h3 style="text-align: center;">ğŸ¾ ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</h3>
          <div class="sidebar-game-controls">
            <div class="control-group">
              <label for="game-lang-select-animal">Ø§Ù„Ù„ØºØ©:</label>
              <select id="game-lang-select-animal">
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="en">English</option>
                <option value="he">Ø¹Ø¨Ø±ÙŠ</option>
              </select>
            </div>
            <div class="control-group">
              <label for="voice-select-animal">Ø§Ù„ØµÙˆØª:</label>
              <select id="voice-select-animal">
                <option value="teacher">Ø§Ù„Ù…Ø¹Ù„Ù…</option>
                <option value="boy">ØµÙˆØª ÙˆÙ„Ø¯</option>
                <option value="girl">ØµÙˆØª Ø¨Ù†Øª</option>
                <option value="child">ØµÙˆØª Ø·ÙÙ„</option>
              </select>
            </div>
            <button id="play-sound-btn-animal" class="control-button">ğŸ”Š Ø§Ø³ØªÙ…Ø¹</button>
            <div class="sidebar-navigation-buttons">
                <button id="prev-animal-btn" class="control-button">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <button id="next-animal-btn" class="control-button">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
            </div>
          </div>
        </div>

        <div id="fruit-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">ğŸ ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ§ÙƒÙ‡</h3>
            <div class="sidebar-game-controls">
                <div class="control-group">
                    <label for="game-lang-select-fruit">Ø§Ù„Ù„ØºØ©:</label>
                    <select id="game-lang-select-fruit">
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="en">English</option>
                        <option value="he">Ø¹Ø¨Ø±ÙŠ</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="voice-select-fruit">Ø§Ù„ØµÙˆØª:</label>
                    <select id="voice-select-fruit">
                        <option value="teacher">Ø§Ù„Ù…Ø¹Ù„Ù…</option>
                        <option value="boy">ØµÙˆØª ÙˆÙ„Ø¯</option>
                        <option value="girl">ØµÙˆØª Ø¨Ù†Øª</option>
                        <option value="child">ØµÙˆØª Ø·ÙÙ„</option>
                    </select>
                </div>
                <button id="play-sound-btn-fruit" class="control-button">ğŸ”Š Ø§Ø³ØªÙ…Ø¹</button>
                <div class="sidebar-navigation-buttons">
                    <button id="prev-fruit-btn" class="control-button">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button id="next-fruit-btn" class="control-button">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                </div>
            </div>
        </div>

        <div id="vegetable-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">ğŸ¥¦ ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª</h3>
            <div class="sidebar-game-controls">
                <div class="control-group">
                    <label for="game-lang-select-vegetable">Ø§Ù„Ù„ØºØ©:</label>
                    <select id="game-lang-select-vegetable">
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="en">English</option>
                        <option value="he">Ø¹Ø¨Ø±ÙŠ</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="voice-select-vegetable">Ø§Ù„ØµÙˆØª:</label>
                    <select id="voice-select-vegetable">
                        <option value="teacher">Ø§Ù„Ù…Ø¹Ù„Ù…</option>
                        <option value="boy">ØµÙˆØª ÙˆÙ„Ø¯</option>
                        <option value="girl">ØµÙˆØª Ø¨Ù†Øª</option>
                        <option value="child">ØµÙˆØª Ø·ÙÙ„</option>
                    </select>
                </div>
                <button id="play-sound-btn-vegetable" class="control-button">ğŸ”Š Ø§Ø³ØªÙ…Ø¹</button>
                <div class="sidebar-navigation-buttons">
                    <button id="prev-vegetable-btn" class="control-button">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button id="next-vegetable-btn" class="control-button">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                </div>
            </div>
        </div>

        <div id="human-body-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">ğŸ§  ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¬Ø³Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù†</h3>
            <div class="sidebar-game-controls">
                <div class="control-group">
                    <label for="game-lang-select-human-body">Ø§Ù„Ù„ØºØ©:</label>
                    <select id="game-lang-select-human-body">
                        <option value="boy">ØµÙˆØª ÙˆÙ„Ø¯</option>
                        <option value="teacher">Ø§Ù„Ù…Ø¹Ù„Ù…</option>
                        <option value="girl">ØµÙˆØª Ø¨Ù†Øª</option>
                        <option value="child">ØµÙˆØª Ø·ÙÙ„</option>
                    </select>
                </div>
                <button id="play-sound-btn-human-body" class="control-button">ğŸ”Š Ø§Ø³ØªÙ…Ø¹</button>
                <div class="sidebar-navigation-buttons">
                    <button id="prev-human-body-btn" class="control-button">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button id="next-human-body-btn" class="control-button">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                </div>
            </div>
        </div>

        <div id="alphabet-press-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">ğŸ® Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø±ÙˆÙ</h3>
            <div class="sidebar-game-controls">
                <div class="control-group">
                    <label for="alphabet-press-language-select">Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©:</label>
                    <select id="alphabet-press-language-select"></select>
                </div>

                <div class="control-group">
                    <label for="alphabet-press-category-select">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©:</label>
                    <select id="alphabet-press-category-select"></select>
                </div>

                <div class="control-group">
                    <label for="alphabet-press-voice-select">Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØª:</label>
                    <select id="alphabet-press-voice-select">
                        <option value="teacher" data-i18n="teacher_voice">Ø§Ù„Ù…Ø¹Ù„Ù…</option>
                        <option value="boy" data-i18n="boy_voice">ØµÙˆØª ÙˆÙ„Ø¯</option>
                        <option value="girl" data-i18n="girl_voice">ØµÙˆØª Ø¨Ù†Øª</option>
                        <option value="child" data-i18n="child_voice">ØµÙˆØª Ø·ÙÙ„</option>
                    </select>
                </div>
                <button id="alphabet-press-play-audio-sidebar" class="control-button">ğŸ”Š Ø§Ø³ØªÙ…Ø¹</button>
            </div>
        </div>

        <div id="memory-game-sidebar-controls" class="sidebar-section" style="display: none;">
            <h3 style="text-align: center;">ğŸƒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h3>
            <div class="sidebar-game-controls memory-game-controls">
                <div class="control-group">
                    <h3>Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©:</h3>
                    <button id="memory-game-lang-ar" class="memory-game-lang-button active">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                    <button id="memory-game-lang-en" class="memory-game-lang-button">English</button>
                </div>
                <div class="control-group topic-selection">
                    <h3>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</h3>
                </div>
                <div class="control-group play-mode-selection">
                    <h3>Ù†Ù…Ø· Ø§Ù„Ù„Ø¹Ø¨:</h3>
                    <button id="memory-game-mode-image-image" class="memory-game-mode-button active">ØµÙˆØ±Ø© - ØµÙˆØ±Ø©</button>
                    <button id="memory-game-mode-image-word" class="memory-game-mode-button">ØµÙˆØ±Ø© - ÙƒÙ„Ù…Ø©</button>
                    <button id="memory-game-mode-image-char" class="memory-game-mode-button">ØµÙˆØ±Ø© - Ø­Ø±Ù</button>
                    <button id="memory-game-mode-image-audio" class="memory-game-mode-button">ØµÙˆØ±Ø© - ØµÙˆØª</button>
                </div>
                <button id="memory-game-start-button" class="memory-game-start-button">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
            </div>
        </div>

        <div class="sidebar-section static-section">
          <h3>ğŸ‘¤ Ø­Ø³Ø§Ø¨Ùƒ</h3>
          <ul>
            <li><a href="#" onclick="loadLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></li>
            <li><a href="#" onclick="loadRegister()">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</a></li>
            <li><a href="#" onclick="loadProfile()">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a></li>
            <li><a href="/users/my-report.html">Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·</a></li>
          </ul>
        </div>
      </aside>

      <main class="main-content">
        <h2 id="welcome-message" style="display: block;">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…ÙˆØ³ÙˆØ¹Ø©!</h2>
        <div id="home-topic-cards" class="home-cards-container">
            <a href="#" class="topic-card animals" onclick="loadAnimalsPage(); return false;">
                <span class="icon">ğŸ¾</span>
                <h3>Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</h3>
            </a>
            <a href="#" class="topic-card fruits" onclick="loadFruitsPage(); return false;">
                <span class="icon">ğŸ</span>
                <h3>Ø§Ù„ÙÙˆØ§ÙƒÙ‡</h3>
            </a>
            <a href="#" class="topic-card vegetables" onclick="loadVegetablesPage(); return false;">
                <span class="icon">ğŸ¥¦</span>
                <h3>Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª</h3>
            </a>
            <a href="#" class="topic-card human-body" onclick="loadHumanBodyPage(); return false;"> <span class="icon">ğŸ§ </span>
                <h3>Ø¬Ø³Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù†</h3>
            </a>
            <a href="#" class="topic-card games" onclick="loadAlphabetPressPage(); return false;">
                <span class="icon">ğŸ” </span>
                <h3>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø±ÙˆÙ</h3> </a>
            <a href="#" class="topic-card games" onclick="loadMemoryGamePage(); return false;">
                <span class="icon">ğŸ§ </span>
                <h3>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h3>
            </a>
        </div>
      </main>
    </div>
  </div>

  <script type="module">
    import { showProfileForm } from '/src/js/profile.js';
    import { loadAnimalsGameContent, showNextAnimal, showPreviousAnimal, playCurrentAnimalAudio } from '/src/js/animals-game.js';
    import { loadFruitsGameContent, showNextFruit, showPreviousFruit, playCurrentFruitAudio } from '/src/js/fruits-game.js';
    import { loadVegetablesGameContent, showNextVegetable, showPreviousVegetable, playCurrentVegetableAudio } from '/src/js/vegetables-game.js';
    import { loadHumanBodyGameContent, showNextHumanBodyPart, showPreviousHumanBodyPart, playCurrentHumanBodyPartAudio } from '/src/js/human-body-game.js';
    import { setDirection, currentLang, loadLanguage, applyTranslations } from '/src/js/lang-handler.js';
	
    import {
        loadAlphabetPressGameContent,
        playCurrentAlphabetItemAudioFromSidebar,
        getCurrentDisplayedItem,
        handleAlphabetPressLanguageChange,
        handleAlphabetPressCategoryChange,
        updateAlphabetPressVoice,
        populateAlphabetPressSidebarOptions
    } from '/src/js/alphabet-press-game.js';

    import {
        loadMemoryGameContent,
        initializeMemoryGameSidebarControls
    } from '/src/js/memory-game.js';


    const mainContentArea = document.querySelector("main.main-content");
    const animalSidebarControls = document.getElementById("animal-sidebar-controls");
    const fruitSidebarControls = document.getElementById("fruit-sidebar-controls");
    const vegetableSidebarControls = document.getElementById("vegetable-sidebar-controls");
    const humanBodySidebarControls = document.getElementById("human-body-sidebar-controls");
    const alphabetPressSidebarControls = document.getElementById("alphabet-press-sidebar-controls");
    const memoryGameSidebarControls = document.getElementById("memory-game-sidebar-controls"); 

    const welcomeMessage = document.getElementById("welcome-message");
    const homeTopicCards = document.getElementById("home-topic-cards");

    window.loadLogin = async () => {
        hideAllControls();
        try {
            const response = await fetch('/users/login-form.html');
            if (!response.ok) throw new Error('Failed to load login form');
            const loginFormHtml = await response.text();
            mainContentArea.innerHTML = loginFormHtml;
        } catch (error) {
            console.error('Error loading login form:', error);
            mainContentArea.innerHTML = '<p style="color: red;">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.</p>';
        }
    };

    window.loadRegister = async () => {
        hideAllControls();
        try {
            const response = await fetch('/users/register-form.html');
            if (!response.ok) throw new Error('Failed to load register form');
            const registerFormHtml = await response.text();
            mainContentArea.innerHTML = registerFormHtml;
        } catch (error) {
            console.error('Error loading register form:', error);
            mainContentArea.innerHTML = '<p style="color: red;">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.</p>';
        }
    };

    window.loadProfile = () => { showProfileForm(); hideAllControls(); };

    window.loadAnimalsPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      await loadAnimalsGameContent();
      showAnimalControls();
      initializeSubjectControls('animal');
    };

    window.loadFruitsPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      await loadFruitsGameContent();
      showFruitControls();
      initializeSubjectControls('fruit');
    };

    window.loadVegetablesPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      await loadVegetablesGameContent();
      showVegetableControls();
      initializeSubjectControls('vegetable');
    };

    window.loadHumanBodyPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      await loadHumanBodyGameContent();
      showHumanBodyControls();
      initializeSubjectControls('human-body');
    };

    // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ù„Ø¹Ø¨Ø© Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±Ù
    window.loadAlphabetPressPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      
      await loadAlphabetPressGameContent(); // ÙŠØªÙ… Ø­Ù‚Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ main-content
      showAlphabetPressControls(); // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ

      // *** Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù† alphabet-press-game.js Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ù‡Ù†Ø§ ***
      await populateAlphabetPressSidebarOptions(); // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø© ÙˆØ³ØªÙ‚ÙˆÙ… Ù‡ÙŠ Ø¨ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†

    };

    // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    window.loadMemoryGamePage = async () => {
        hideAllControls();
        if (welcomeMessage) welcomeMessage.style.display = 'none';
        if (homeTopicCards) homeTopicCards.style.display = 'none';
        
        // Ù‚Ù… Ø¨ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø£ÙˆÙ„Ø§Ù‹
        if (memoryGameSidebarControls) {
            await initializeMemoryGameSidebarControls();
            showMemoryGameControls();
        } else {
            console.error("Memory game sidebar controls not found. Cannot initialize.");
        }

        await loadMemoryGameContent(); 
    };

    window.showHomePage = () => {
        mainContentArea.innerHTML = `
            <h2 id="welcome-message-inner" style="display: block;">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…ÙˆØ³ÙˆØ¹Ø©!</h2>
            <div id="home-topic-cards-inner" class="home-cards-container">
                <a href="#" class="topic-card animals" onclick="loadAnimalsPage(); return false;">
                    <span class="icon">ğŸ¾</span>
                    <h3>Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</h3>
                </a>
                <a href="#" class="topic-card fruits" onclick="loadFruitsPage(); return false;">
                    <span class="icon">ğŸ</span>
                    <h3>Ø§Ù„ÙÙˆØ§ÙƒÙ‡</h3>
                </a>
                <a href="#" class="topic-card vegetables" onclick="loadVegetablesPage(); return false;">
                    <span class="icon">ğŸ¥¦</span>
                    <h3>Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª</h3>
                </a>
                <a href="#" class="topic-card human-body" onclick="loadHumanBodyPage(); return false;">
                    <span class="icon">ğŸ§ </span>
                    <h3>Ø¬Ø³Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù†</h3>
                </a>
                <a href="#" class="topic-card games" onclick="loadAlphabetPressPage(); return false;">
                    <span class="icon">ğŸ” </span>
                    <h3>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø±ÙˆÙ</h3> </a>
                <a href="#" class="topic-card games" onclick="loadMemoryGamePage(); return false;">
                    <span class="icon">ğŸ§ </span>
                    <h3>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h3>
                </a>
            </div>
        `;
        hideAllControls();

        const defaultLang = localStorage.getItem("lang") || "ar";
        setDirection(defaultLang);
    };

    function showAnimalControls() { if (animalSidebarControls) { animalSidebarControls.style.display = 'block'; } }
    function hideAnimalControls() { if (animalSidebarControls) { animalSidebarControls.style.display = 'none'; } }
    function showFruitControls() { if (fruitSidebarControls) { fruitSidebarControls.style.display = 'block'; } }
    function hideFruitControls() { if (fruitSidebarControls) { fruitSidebarControls.style.display = 'none'; } }
    function showVegetableControls() { if (vegetableSidebarControls) { vegetableSidebarControls.style.display = 'block'; } }
    function hideVegetableControls() { if (vegetableSidebarControls) { vegetableSidebarControls.style.display = 'none'; } }
    function showHumanBodyControls() { if (humanBodySidebarControls) { humanBodySidebarControls.style.display = 'block'; } }
    function hideHumanBodyControls() { if (humanBodySidebarControls) { humanBodySidebarControls.style.display = 'none'; } }
    function showAlphabetPressControls() { if (alphabetPressSidebarControls) { alphabetPressSidebarControls.style.display = 'block'; } }
    function hideAlphabetPressControls() { if (alphabetPressSidebarControls) { alphabetPressSidebarControls.style.display = 'none'; } }
    function showMemoryGameControls() { if (memoryGameSidebarControls) { memoryGameSidebarControls.style.display = 'block'; } }
    function hideMemoryGameControls() { if (memoryGameSidebarControls) { memoryGameSidebarControls.style.display = 'none'; } }


    function hideAllControls() {
        hideAnimalControls();
        hideFruitControls();
        hideVegetableControls();
        hideHumanBodyControls();
        hideAlphabetPressControls();
        hideMemoryGameControls();
    }

    const availableCategories = [
        { id: 'animals', name_ar: 'Ø­ÙŠÙˆØ§Ù†Ø§Øª', name_en: 'Animals', name_he: '×—×™×•×ª' },
        { id: 'fruits', name_ar: 'ÙÙˆØ§ÙƒÙ‡', name_en: 'Fruits', name_he: '×¤×™×¨×•×ª' },
        { id: 'vegetables', name_ar: 'Ø®Ø¶Ø±ÙˆØ§Øª', name_en: 'Vegetables', name_he: '×™×¨Ù‚Ø§Øª' },
        { id: 'human-body', name_ar: 'Ø¬Ø³Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù†', name_en: 'Human Body', name_he: '×’×•×£ ×”××“×' },
    ];

    // Ø¯Ø§Ù„Ø© initializeSubjectControls Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ù„ÙƒÙ„ Ù…ÙˆØ¶ÙˆØ¹
    async function initializeSubjectControls(subjectType) {
        let langSelect, voiceSelect, playSoundBtn, prevBtn, nextBtn;
        let loadContentFunc, showNextFunc, showPrevFunc, playAudioFunc;

        switch(subjectType) {
            case 'animal':
                langSelect = document.getElementById('game-lang-select-animal');
                voiceSelect = document.getElementById('voice-select-animal');
                playSoundBtn = document.getElementById('play-sound-btn-animal');
                prevBtn = document.getElementById('prev-animal-btn');
                nextBtn = document.getElementById('next-animal-btn');
                loadContentFunc = loadAnimalsGameContent;
                showNextFunc = showNextAnimal;
                showPrevFunc = showPreviousAnimal;
                playAudioFunc = playCurrentAnimalAudio;
                break;
            case 'fruit':
                langSelect = document.getElementById('game-lang-select-fruit');
                voiceSelect = document.getElementById('voice-select-fruit');
                playSoundBtn = document.getElementById('play-sound-btn-fruit');
                prevBtn = document.getElementById('prev-fruit-btn');
                nextBtn = document.getElementById('next-fruit-btn');
                loadContentFunc = loadFruitsGameContent;
                showNextFunc = showNextFruit;
                showPrevFunc = showPreviousFruit;
                playAudioFunc = playCurrentFruitAudio;
                break;
            case 'vegetable':
                langSelect = document.getElementById('game-lang-select-vegetable');
                voiceSelect = document.getElementById('voice-select-vegetable');
                playSoundBtn = document.getElementById('play-sound-btn-vegetable');
                prevBtn = document.getElementById('prev-vegetable-btn');
                nextBtn = document.getElementById('next-vegetable-btn');
                loadContentFunc = loadVegetablesGameContent;
                showNextFunc = showNextVegetable;
                showPrevFunc = showPreviousVegetable;
                playAudioFunc = playCurrentVegetableAudio;
                break;
            case 'human-body':
                langSelect = document.getElementById('game-lang-select-human-body');
                voiceSelect = document.getElementById('voice-select-human-body');
                playSoundBtn = document.getElementById('play-sound-btn-human-body');
                prevBtn = document.getElementById('prev-human-body-btn');
                nextBtn = document.getElementById('next-human-body-btn');
                loadContentFunc = loadHumanBodyGameContent;
                showNextFunc = showNextHumanBodyPart;
                showPrevFunc = showPreviousHumanBodyPart;
                playAudioFunc = playCurrentHumanBodyPartAudio;
                break;
            default:
                return;
        }

        if (!langSelect || !voiceSelect) {
            console.error(`Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ '${subjectType}' Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ DOM.`);
            return;
        }

        if (langSelect.options.length === 0) {
            ['ar', 'en', 'he'].forEach(langCode => {
                const option = document.createElement('option');
                option.value = langCode;
                option.textContent = { 'ar': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'en': 'English', 'he': '×¢×‘×¨×™×ª' }[langCode];
                langSelect.appendChild(option);
            });
            langSelect.value = currentLang;
        }

        if (voiceSelect.options.length === 0) {
            ['teacher', 'boy', 'girl', 'child'].forEach(voiceType => {
                const option = document.createElement('option');
                option.value = voiceType;
                option.textContent = { 'teacher': 'Ø§Ù„Ù…Ø¹Ù„Ù…', 'boy': 'ØµÙˆØª ÙˆÙ„Ø¯', 'girl': 'ØµÙˆØª Ø¨Ù†Øª', 'child': 'ØµÙˆØª Ø·ÙÙ„' }[voiceType];
                voiceSelect.appendChild(option);
            });
            voiceSelect.value = 'teacher';
        }

        langSelect.onchange = async () => {
            const newLang = langSelect.value;
            await loadLanguage(newLang);
            applyTranslations();
            setDirection(newLang);
            await loadContentFunc();
        };

        voiceSelect.onchange = () => {
            // Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØª ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ (Ù…Ø«Ù„ animals-game.js)
            // Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ø§ ØªÙ…Ø±Ø± Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø©ØŒ Ø¨Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ³ØªØ®Ø¯Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„Ù€ select
            // ÙˆÙ„Ø°Ù„Ùƒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¯Ø§Ù„Ø© update Ù‡Ù†Ø§
        };

        if (playSoundBtn) playSoundBtn.onclick = () => {
            playAudioFunc();
        };

        if (prevBtn) prevBtn.onclick = () => {
            showPrevFunc();
        };

        if (nextBtn) nextBtn.onclick = () => {
            showNextFunc();
        };

        applyTranslations();
    }


    document.addEventListener('DOMContentLoaded', () => {
        window.showHomePage();
    });
  </script>
</body>
</html>
ØªÙ…Ø§Ù…ØŒ Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ù„Ù‚Ø·ØªÙŠ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø© (Ø®Ø§ØµØ© `index.html` Ùˆ `memory-game.js` Ùˆ `alphabet-press-game.js`) ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©.

**Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:**

1.  **Ù„Ø¹Ø¨Ø© Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±Ù:** `Failed to get references for alphabet press sidebar controls.` (Ù„Ø§ ØªØ²Ø§Ù„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ø§ ØªØ¸Ù‡Ø±).
2.  **Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©:** `Missing or Insufficient permissions` Ù…Ù† Firestore (Ù„Ø§ ØªØ²Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ø§ ØªØ¸Ù‡Ø±).
3.  **Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©:** `ReferenceError: currentLanguage is not defined` (Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§).

---

## ØªØ­Ù„ÙŠÙ„ ÙˆØ­Ù„ÙˆÙ„ Ù…ÙØµÙ„Ø©:

### 1. **Ø®Ø·Ø£ "Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø±ÙˆÙ" (Sidebar Controls Not Found):**

* **Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Ø§Ù„Ø®Ø·Ø£ `Failed to get references for alphabet press sidebar controls.` ÙŠØ­Ø¯Ø« Ù„Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ `index.html` ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…Ø«Ù„ `alphabet-press-language-select` Ù‚Ø¨Ù„ Ø£Ù† ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù† Ø¥ÙŠØ¬Ø§Ø¯Ù‡Ø§ ÙÙŠ Ø§Ù„Ù€ DOMØŒ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ `showAlphabetPressControls()`. Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªÙˆÙ‚ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„ ÙƒØªÙ„Ø© `script type="module"` Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ `index.html`.
* **Ø§Ù„Ø­Ù„:**
    * Ø§Ù„Ø¯Ø§Ù„Ø© `populateAlphabetPressSidebarOptions()` ÙÙŠ `alphabet-press-game.js` Ù‡ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø¨Ù‡Ø§. ÙŠØ¬Ø¨ Ø£Ù† ØªÙØ³ØªØ¯Ø¹Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© **ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø£Ù† ØªÙƒÙˆÙ† Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù‡Ø°Ù‡ Ù…ØªÙˆÙØ±Ø© ØªÙ…Ø§Ù…Ù‹Ø§ ÙÙŠ Ø§Ù„Ù€ DOM ÙˆÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§**.
    * Ø§Ù„Ø­Ù„ Ù‡Ùˆ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ…Ø±Ø¦ÙŠØ© ÙÙŠ Ø§Ù„Ù€ DOM Ø¹Ù†Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ `populateAlphabetPressSidebarOptions()`. Ø¨Ù…Ø§ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ HTML Ø§Ù„Ø«Ø§Ø¨Øª Ù„Ù€ `index.html` ÙˆØªÙƒÙˆÙ† Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ØŒ ÙØ¥Ù† Ø¥Ø¸Ù‡Ø§Ø± `alphabetPressSidebarControls` Ø£ÙˆÙ„Ø§Ù‹ Ø³ÙŠØ¬Ø¹Ù„Ù‡Ø§ Ù…ØªØ§Ø­Ø© Ù„Ù„ÙˆØµÙˆÙ„.

    **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ `public/index.html` (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ `window.loadAlphabetPressPage`):**
    ```html
    // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ù„Ø¹Ø¨Ø© Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±Ù
    window.loadAlphabetPressPage = async () => {
      hideAllControls();
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (homeTopicCards) homeTopicCards.style.display = 'none';
      
      showAlphabetPressControls(); // *** Ø§Ø¬Ø¹Ù„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù…Ø±Ø¦ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ ***
      // Ø§Ù„Ø¢Ù†ØŒ ÙˆØ¨Ø¹Ø¯ Ø£Ù† Ø£ØµØ¨Ø­Øª Ù…Ø±Ø¦ÙŠØ©ØŒ Ø§Ø³ØªØ¯Ø¹Ù Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡Ø§ ÙˆØªÙ‡ÙŠØ¦Ù‡Ø§
      await populateAlphabetPressSidebarOptions(); 

      // Ø«Ù… Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      await loadAlphabetPressGameContent(); 
    };
    ```
    * **Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø© Ø¬Ø¯Ø§Ù‹:** ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ± (`alphabet-press-language-select` Ùˆ `alphabet-press-category-select` ÙˆØºÙŠØ±Ù‡Ø§) Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ `index.html` Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¶Ù…Ù† `div` Ø§Ù„Ø£Ø¨ `alphabet-press-sidebar-controls`ØŒ ÙˆÙ„ÙŠØ³ ÙŠØªÙ… Ø­Ù‚Ù†Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ Ù…Ù† Ù…ÙƒØ§Ù† Ø¢Ø®Ø±. Ø§Ù„Ù€ HTML ÙÙŠ Ù…Ù„Ù `index.html` Ø§Ù„Ù…Ø±ÙÙ‚ ÙŠÙØ¸Ù‡Ø± Ø£Ù†Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±ØŒ ÙˆÙ‡Ø°Ø§ Ø¬ÙŠØ¯.

### 2. **Ø®Ø·Ø£ "Ø§Ù„Ø°Ø§ÙƒØ±Ø©" - `Missing or Insufficient permissions` (Firestore):**

* **Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Ø§Ù„Ø®Ø·Ø£ `Missing or Insufficient permissions` ÙŠØ¹Ù†ÙŠ Ø£Ù† Firebase Firestore ÙŠØ±ÙØ¶ Ø·Ù„Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ø°Ø§ Ù„Ø§ ÙŠØ²Ø§Ù„ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ **Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firebase Firestore** Ø£Ùˆ Ø¹Ø¯Ù… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­. Ù„Ù‚Ø·Ø© Ø§Ù„Ø´Ø§Ø´Ø© "image_7f3ddd.png" ØªÙØ¸Ù‡Ø± Ø£Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© `allow read: if true;` Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ÙˆÙ„ÙƒÙ† Ø§Ù„Ø®Ø·Ø£ Ù„Ø§ ÙŠØ²Ø§Ù„ ÙŠØ­Ø¯Ø«.
* **Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:**
    1.  **Ø§Ù„Ù†Ø´Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ù‚ÙˆØ©:** Ø§Ø±Ø¬Ø¹ Ø¥Ù„Ù‰ Firebase Console -> Firestore Database -> Rules. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ **"Publish" Ù…Ø±Ø© Ø£Ø®Ø±Ù‰**. ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø­ÙŠØ§Ù†ØŒ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø§Øª Ù…Ø¤Ù‚ØªØ© ÙÙŠ Ø§Ù„Ù†Ø´Ø±.
    2.  **ØªØ­Ù‚Ù‚ Ù…Ù† Ù„ÙˆØ­Ø© "Network":** ÙÙŠ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ± (F12) ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ØŒ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ `Network`.
        * Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø§Ù„Ø°Ø§ÙƒØ±Ø©".
        * Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª `firestore.googleapis.com`. Ø§Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡Ø§.
        * Ù…Ø§ Ù‡Ùˆ **Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„Ø© (Status Code)** Ø§Ù„Ø°ÙŠ ØªØ­ØµÙ„ Ø¹Ù„ÙŠÙ‡ (Ù…Ø«Ù„Ø§Ù‹ 200 OKØŒ 403 Forbidden)ØŸ
        * Ù…Ø§Ø°Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ **"Response"** Ø£Ùˆ **"Preview"** Ù„Ù„Ø·Ù„Ø¨ØŸ Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹ Ù…Ù† FirebaseØŸ Ù‡Ø°Ø§ Ø³ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ù†ÙØ³Ù‡Ø§ Ø£Ùˆ ÙÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø± (Ù…Ø«Ù„ Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø°ÙŠ ÙŠØ·Ù„Ø¨Ù‡ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª).
    3.  **Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©:** ÙÙŠ Firebase Console -> Firestore Database -> DataØŒ ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªÙ…Ù„Ùƒ ÙØ¹Ù„Ø§Ù‹:
        * `categories` (Ù…Ø¬Ù…ÙˆØ¹Ø©)
        * Ø¯Ø§Ø®Ù„Ù‡Ø§ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù…Ø«Ù„ `animals`, `fruits` (ÙƒÙ„ Ù…Ù†Ù‡Ø§ ÙƒÙ€ Document).
        * Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ø³ØªÙ†Ø¯ØŒ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙØ±Ø¹ÙŠØ© ØªØ³Ù…Ù‰ `items`.
        * Ø¯Ø§Ø®Ù„ `items`ØŒ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„ÙƒÙ„ Ø¹Ù†ØµØ± (Ù…Ø«Ù„Ø§Ù‹ `bear`, `apple`).
        * ÙˆØ£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù…Ø«Ù„ `name`, `image`, `letter`, `voices`) Ø¨Ù†ÙØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø°ÙŠ ØªØªÙˆÙ‚Ø¹Ù‡ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.

### 4. **Ø®Ø·Ø£ "Ø§Ù„Ø°Ø§ÙƒØ±Ø©" - `ReferenceError: currentLanguage is not defined`:**

* **Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ù…ØªØºÙŠØ± `currentLanguage` Ù„Ù… ÙŠØ¹Ø¯ Ù…Ø¹Ø±ÙÙ‹Ø§ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø°ÙŠ ÙŠØ³ØªØ®Ø¯Ù… ÙÙŠÙ‡. ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ Ù‚Ù…Ù†Ø§ Ø¨ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª `currentLanguage` Ø¥Ù„Ù‰ `currentLang` (Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ Ù…Ù† `lang-handler.js`). ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù…ÙƒØ§Ù†Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡.
* **Ø§Ù„Ø­Ù„:** Ø³Ø£Ù‚ÙˆÙ… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù…Ù„Ù `memory-game.js` Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŒ Ù…Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¨Ø´ÙƒÙ„ Ø®Ø§Øµ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù…Ø«ÙŠÙ„Ø§Øª `currentLanguage` ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù€ `currentLang`.

---

## Ù…Ø±Ø§Ø¬Ø¹Ø© `public/js/memory-game.js` (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† `currentLang`):

Ø³Ø£Ù‚Ø¯Ù… Ù„Ùƒ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù…Ù„Ù `memory-game.js` Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… `currentLang` ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù† Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† `currentLanguage`.

```javascript
// E:\cyclopedia\src\js\memory-game.js (ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø±: src/js/)

import { db } from './firebase-config.js';
import { collection, getDocs } from 'firebase/firestore';
import { currentLang, loadLanguage, applyTranslations, setDirection } from './lang-handler.js'; // Ø§Ø³ØªÙŠØ±Ø§Ø¯ currentLang
import { playAudio, stopCurrentAudio } from './audio-handler.js';
import { recordActivity } from './activity-handler.js';

// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªØ³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ù…Ø¹Ø±ÙØ© ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù„Ù„ÙˆØ­Ø¯Ø©
let gameBoard;
let startGameButton;
let langButtons;
let topicButtons = []; 
let modeButtons;
let gameStatusDisplay;

let cards = [];
let flippedCards = [];
let matchedPairs = 0;
let lockBoard = false;

let allCardData = {}; 
let currentTopic = 'animals'; 
let currentPlayMode = 'image-image'; 

// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø³ØªÙØ³ØªØ¯Ø¹Ù‰ Ù…Ù† index.html Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØªÙ‡ÙŠØ¦ØªÙ‡
export async function loadMemoryGameContent() {
    console.log('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©...');

    const mainContentArea = document.querySelector('.main-content');
    // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø¹Ø¨Ø© (game-board, game-status) Ø³ÙŠÙØ­Ù‚Ù† Ù‡Ù†Ø§
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø¸Ù‡ÙˆØ±Ù‡Ø§ØŒ ÙÙ‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§
    mainContentArea.innerHTML = `
        <h1>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h1>
        <div class="memory-game-grid" id="memory-game-board">
            </div>
        <div class="game-status" id="memory-game-status">
            </div>
    `;

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€ DOM Ø¨Ø¹Ø¯ Ø­Ù‚Ù† Ø§Ù„Ù€ HTML
    // Ù‡Ø°Ø§ Ø£Ù…Ø± Ø­Ø§Ø³Ù…ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ù€ innerHTML
    gameBoard = document.getElementById('memory-game-board');
    gameStatusDisplay = document.getElementById('memory-game-status');
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
    // ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ populateTopicButtons Ùˆ createBoard Ø¯Ø§Ø®Ù„ fetchCardData
    await fetchCardData();
}

// Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©
// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø³ØªÙØ³ØªØ¯Ø¹Ù‰ Ù…Ù† index.html ÙˆÙŠØ¬Ø¨ Ø£Ù† ØªÙ‡ØªÙ… ÙÙ‚Ø· Ø¨Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
export async function initializeMemoryGameSidebarControls() {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù€ DOM
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ù‡ IDs ÙˆØ§Ù„ÙØ¦Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ HTML Ù…Ù„Ù index.html
    startGameButton = document.getElementById('memory-game-start-button');
    langButtons = document.querySelectorAll('.memory-game-lang-button');
    modeButtons = document.querySelectorAll('.memory-game-mode-button');

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    setupEventListeners();
    
    // Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ØºØ©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ currentLang Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
    // currentLang Ù‡Ùˆ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ Ù…Ù† lang-handler
    langButtons.forEach(button => {
        if (button.id === `memory-game-lang-${currentLang}`) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });

    // Populate topic buttons if data is already fetched
    // Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ù„Ù€ populateTopicButtons Ø¨Ø§Ù„Ø¹Ù…Ù„ Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¨ÙƒØ±Ù‹Ø§
    if (Object.keys(allCardData).length > 0) {
        populateTopicButtons();
    }
}


function setupEventListeners() {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯Ø¯ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
    if (startGameButton) {
        startGameButton.removeEventListener('click', createBoard);
        startGameButton.addEventListener('click', createBoard);
    }

    if (langButtons) {
        langButtons.forEach(button => {
            button.removeEventListener('click', handleLanguageChange);
            button.addEventListener('click', handleLanguageChange);
        });
    }

    if (modeButtons) {
        modeButtons.forEach(button => {
            button.removeEventListener('click', handleModeChange);
            button.addEventListener('click', handleModeChange);
        });
    }
}

function handleLanguageChange(event) {
    langButtons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    // ØªØ­Ø¯ÙŠØ« currentLang Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© loadLanguage Ù…Ù† lang-handler
    loadLanguage(event.target.id === 'memory-game-lang-ar' ? 'ar' : 'en').then(() => {
        // Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©
        updateCardTexts();
        // Ø£ÙŠØ¶Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù„Ø¹Ø¨Ø© Ù†Ø´Ø·Ø©)
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØºÙŠØ± Ø§Ù„Ù„ØºØ© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ updateCardTexts ØªÙƒÙÙŠ.
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØºÙŠØ±Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ØŒ ÙÙ€ createBoard Ø³ÙŠØ·Ø¨Ù‚Ù‡Ø§.
    });
}

function handleModeChange(event) {
    modeButtons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    currentPlayMode = event.target.id.replace('memory-game-mode-', '');
    createBoard(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯
}


async function fetchCardData() {
    if (!db) {
        console.error("Firestore DB not initialized. Cannot fetch data.");
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'ÙØ´Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.' : 'Database setup failed.');
        return;
    }

    try {
        const categoriesSnapshot = await getDocs(collection(db, "categories"));
        
        const categoriesData = {};
        for (const doc of categoriesSnapshot.docs) {
            const categoryName = doc.id;
            const itemsCollectionRef = collection(db, "categories", categoryName, "items");
            const itemsSnapshot = await getDocs(itemsCollectionRef);
            
            categoriesData[categoryName] = itemsSnapshot.docs.map(itemDoc => {
                const data = itemDoc.data();
                return {
                    id: itemDoc.id,
                    image_name: data.image,
                    name_ar: data.name.ar,
                    name_en: data.name.en,
                    letter_ar: data.letter ? data.letter.ar : '',
                    letter_en: data.letter ? data.letter.en : '',
                    audio_ar: data.voices && data.voices.ar ? data.voices.ar : '',
                    audio_en: data.voices && data.voices.en ? data.voices.en : '',
                };
            });
        }
        allCardData = categoriesData;
        
        // Ø¨Ù…Ø¬Ø±Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù‚Ù… Ø¨ØªÙ‡ÙŠØ¦Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹
        populateTopicButtons(); 
        createBoard(); // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
        
    } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù† Firestore:', error);
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.' : 'Failed to load data. Check internet connection.');
    }
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function createBoard() {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† gameBoard Ù‚Ø¯ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø¬Ø¹Ù‡
    if (!gameBoard) {
        console.error("Game board element not found in createBoard.");
        return;
    }
    gameBoard.innerHTML = '';
    gameStatusDisplay.textContent = '';

    flippedCards = [];
    matchedPairs = 0;
    lockBoard = false;

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentTopic
    const selectedTopicItems = allCardData[currentTopic];
    if (!selectedTopicItems || selectedTopicItems.length < 6) {
        console.warn(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…ÙˆØ¶ÙˆØ¹ ${currentTopic} Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.`);
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹.' : 'Not enough data for this topic.');
        return;
    }

    const shuffledTopicItems = shuffleArray([...selectedTopicItems]);
    const chosenItems = shuffledTopicItems.slice(0, 6);

    const gameCardsForMode = [];

    chosenItems.forEach(item => {
        if (currentPlayMode === 'image-image') {
            gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
            gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
        }
        else if (currentPlayMode === 'image-word') {
            gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
            gameCardsForMode.push({ type: 'word', value: (currentLang === 'ar' ? item.name_ar : item.name_en), id: item.id, text_ar: item.name_ar, text_en: item.name_en });
        }
        else if (currentPlayMode === 'image-char') {
            if (item.letter_ar && item.letter_en) {
                gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
                gameCardsForMode.push({ type: 'char', value: (currentLang === 'ar' ? item.letter_ar : item.letter_en), id: item.id, text_ar: item.name_ar, text_en: item.name_en });
            } else {
                console.warn(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø±Ù Ù„Ù€ ${item.id} ÙÙŠ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ${currentTopic}. Ø³ÙŠØªÙ… ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…Ø·.`);
            }
        }
        else if (currentPlayMode === 'image-audio') {
            if (item.audio_ar && item.audio_en) {
                gameCardsForMode.push({ type: 'image', value: `images/${currentTopic}/${item.image_name}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en });
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
                gameCardsForMode.push({ type: 'audio', value: `audio/${currentLang}/${currentTopic}/${currentLang === 'ar' ? item.audio_ar : item.audio_en}`, id: item.id, text_ar: item.name_ar, text_en: item.name_en, image_url_for_audio_card: `images/${currentTopic}/${item.image_name}` });
            } else {
                console.warn(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØª Ù„Ù€ ${item.id} ÙÙŠ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ${currentTopic}. Ø³ÙŠØªÙ… ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…Ø·.`);
            }
        }
    });

    if (gameCardsForMode.length < 12) {
         // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
         gameStatusDisplay.textContent = (currentLang === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…Ø· ÙˆØ§Ù„Ù…ÙˆØ¶ÙˆØ¹.' : 'Not enough items for this mode and topic.');
         console.error("Not enough cards generated for the selected mode.");
         return;
    }

    const shuffledCards = shuffleArray(gameCardsForMode);

    shuffledCards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.classList.add('memory-card');
        cardElement.dataset.cardId = card.id;
        cardElement.dataset.cardType = card.type;

        let frontContent = '';
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
        let cardText = currentLang === 'ar' ? card.text_ar : card.text_en;

        if (card.type === 'image') {
            frontContent = `<img src="${card.value}" alt="${card.id}">`;
        } else if (card.type === 'word' || card.type === 'char') {
            frontContent = `<span class="card-display-text">${card.value}</span>`;
        } else if (card.type === 'audio') {
            frontContent = `
                <img src="${card.image_url_for_audio_card}" alt="${card.id}">
                <audio src="${card.value}" preload="auto"></audio>
                <button class="play-audio-btn">â–¶</button>
            `;
        }

        cardElement.innerHTML = `
            <div class="front-face">
                ${frontContent}
                <span class="card-text">${cardText}</span>
            </div>
            <div class="back-face"></div>
        `;
        
        if (card.type === 'audio') {
            const playButton = cardElement.querySelector('.play-audio-btn');
            if (playButton) {
                playButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const audio = cardElement.querySelector('audio');
                    if (audio) {
                        playAudio(audio.src);
                    }
                });
            }
        }

        cardElement.addEventListener('click', flipCard);
        gameBoard.appendChild(cardElement);
    });

    cards = document.querySelectorAll('.memory-card');
}

function flipCard() {
    if (lockBoard) return;
    if (this === flippedCards[0]) return;

    this.classList.add('flipped');
    flippedCards.push(this);

    if (flippedCards.length === 2) {
        lockBoard = true;
        checkForMatch();
    }
}

function checkForMatch() {
    const [firstCard, secondCard] = flippedCards;
    const firstCardId = firstCard.dataset.cardId;
    const secondCardId = secondCard.dataset.cardId;
    const firstCardType = firstCard.dataset.cardType;
    const secondCardType = secondCard.dataset.cardType;

    let isMatch = false;

    if (firstCardId === secondCardId) {
        if (currentPlayMode === 'image-image') {
            isMatch = (firstCardType === 'image' && secondCardType === 'image');
        } else if (currentPlayMode === 'image-word') {
            isMatch = (
                (firstCardType === 'image' && secondCardType === 'word') ||
                (firstCardType === 'word' && secondCardType === 'image')
            );
        } else if (currentPlayMode === 'image-char') {
             isMatch = (
                (firstCardType === 'image' && secondCardType === 'char') ||
                (firstCardType === 'char' && secondCardType === 'image')
            );
        } else if (currentPlayMode === 'image-audio') {
             isMatch = (
                (firstCardType === 'image' && secondCardType === 'audio') ||
                (firstCardType === 'audio' && secondCardType === 'image')
            );
        }
    }

    if (isMatch) {
        disableCards();
        matchedPairs++;
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'Ù„Ù‚Ø¯ ÙˆØ¬Ø¯Øª Ø²ÙˆØ¬Ù‹Ø§!' : 'You found a pair!');
        const currentUser = JSON.parse(localStorage.getItem("user"));
        if (currentUser) {
            recordActivity(currentUser, currentTopic);
        }

        if (matchedPairs === 6) {
            setTimeout(() => {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
                gameStatusDisplay.textContent = (currentLang === 'ar' ? 'ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ ÙØ²Øª Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©!' : 'Congratulations! You won the game!');
            }, 500);
        }
    } else {
        unflipCards();
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
        gameStatusDisplay.textContent = (currentLang === 'ar' ? 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.' : 'Try again.');
    }
}

function disableCards() {
    flippedCards.forEach(card => {
        card.removeEventListener('click', flipCard);
        card.classList.add('matched');
    });
    resetBoard();
}

function unflipCards() {
    setTimeout(() => {
        flippedCards.forEach(card => card.classList.remove('flipped'));
        resetBoard();
    }, 1000);
}

function resetBoard() {
    [flippedCards, lockBoard] = [[], false];
}

function updateCardTexts() {
    cards.forEach(cardElement => {
        const cardId = cardElement.dataset.cardId;
        const cardType = cardElement.dataset.cardType;
        const topicItems = allCardData[currentTopic];
        const originalItem = topicItems ? topicItems.find(data => data.id === cardId) : null;

        if (originalItem) {
            const cardTextSpan = cardElement.querySelector('.card-text');
            if (cardTextSpan) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
                cardTextSpan.textContent = currentLang === 'ar' ? originalItem.name_ar : originalItem.name_en;
            }

            if (cardType === 'word') {
                 const displaySpan = cardElement.querySelector('.card-display-text');
                 // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
                 if(displaySpan) displaySpan.textContent = currentLang === 'ar' ? originalItem.name_ar : originalItem.name_en;
            } else if (cardType === 'char') {
                const displaySpan = cardElement.querySelector('.card-display-text');
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§
                if(displaySpan) displaySpan.textContent = currentLang === 'ar' ? originalItem.letter_ar : originalItem.letter_en;
            } else if (cardType === 'audio') {
                const audioElem = cardElement.querySelector('audio');
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLang Ù‡Ù†Ø§ (ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØª)
                if(audioElem) audioElem.src = `audio/${currentLang}/${currentTopic}/${currentLang === 'ar' ? originalItem.audio_ar : originalItem.audio_en}`;
            }
        }
    });
}

const topicSelectionDiv = document.querySelector('#memory-game-sidebar-controls .topic-selection');
export function populateTopicButtons() {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† topicSelectionDiv Ù…ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹Ù‡
    if (!topicSelectionDiv) {
        console.error("Topic selection div not found in memory game sidebar controls for populateTopicButtons.");
        return;
    }
    topicSelectionDiv.innerHTML = '<h3>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</h3>';

    const categories = Object.keys(allCardData);
    
    const sidebarTopicButtons = [];

    categories.forEach(topicKey => {
        const button = document.createElement('button');
        button.id = `memory-game-topic-${topicKey}`;
        button.classList.add('memory-game-topic-button');
        button.textContent = topicKey.charAt(0).toUpperCase() + topicKey.slice(1);

        if (topicKey === currentTopic) {
            button.classList.add('active');
        }

        button.addEventListener('click', () => {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø·Ø§Ù‚ Ø£ÙƒØ«Ø± ØªØ­Ø¯ÙŠØ¯Ù‹Ø§ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('#memory-game-sidebar-controls .memory-game-topic-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentTopic = topicKey;
            createBoard();
        });
        topicSelectionDiv.appendChild(button);
        sidebarTopicButtons.push(button);
    });
    topicButtons = sidebarTopicButtons;
}